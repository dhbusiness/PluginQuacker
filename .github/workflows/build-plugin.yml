name: Build Tremolo Viola Plugin

# This allows you to run this workflow manually from the Actions tab
on:
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Install Dependencies
        run: |
          brew update
          brew install wget cmake
          
      - name: Download and Extract JUCE
        run: |
          # Download latest JUCE
          wget https://github.com/juce-framework/JUCE/archive/refs/heads/master.zip -O juce.zip
          unzip juce.zip
          mv JUCE-master JUCE
      
      - name: Update JUCE Paths in .jucer File
        run: |
          # Get the absolute path to the JUCE modules directory
          JUCE_MODULES_PATH="$(pwd)/JUCE/modules"
          echo "JUCE modules path: $JUCE_MODULES_PATH"
          
          # Update the .jucer file to use the correct path
          # This uses sed to replace the path attribute in the JUCEOPTIONS element
          sed -i '' "s|path=\".*modules\"|path=\"$JUCE_MODULES_PATH\"|g" QuackerVST/QuackerVST.jucer
          
          # Print the modified part of the file to verify
          echo "Updated .jucer file paths:"
          grep -A 5 "JUCERPROJECT" QuackerVST/QuackerVST.jucer
          
      - name: Build Projucer
        run: |
          # Navigate to Projucer directory and build
          cd JUCE/extras/Projucer/Builds/MacOSX
          xcodebuild -project Projucer.xcodeproj -configuration "Release" -jobs 4
          
      - name: Move Projucer to Convenient Location
        run: |
          # Make Projucer accessible
          mkdir -p bin
          cp JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app/Contents/MacOS/Projucer bin/
          chmod +x bin/Projucer
          
      - name: Create Project with Projucer
        run: |
          # Get the absolute path to the Projucer executable
          PROJUCER_PATH=$(pwd)/bin/Projucer
          
          # Navigate to the root of the repository
          cd $GITHUB_WORKSPACE
          
          # Debug: Examine the .jucer file
          echo "First 50 lines of the .jucer file:"
          head -n 50 QuackerVST/QuackerVST.jucer
          
          # Resave the project file
          "$PROJUCER_PATH" --resave "QuackerVST/QuackerVST.jucer"
          
          # Create the Builds directory if it doesn't exist
          mkdir -p Builds/MacOSX
          
          # Export to Xcode
          "$PROJUCER_PATH" --export-xcode "QuackerVST/QuackerVST.jucer" "Builds/MacOSX"
        
      - name: Build Plugin
        run: |
          # Navigate to the Xcode project directory and build
          cd Builds/MacOSX
          
          # List contents to debug
          echo "Contents of Builds/MacOSX:"
          ls -la
          
          xcodebuild -project TremoloViolaVST.xcodeproj -configuration "Release" -jobs 4
          
      - name: Package Plugin
        run: |
          # Create directory for packaging
          mkdir -p package/VST3
          mkdir -p package/AU
          
          # List build outputs to debug
          echo "Contents of build directory:"
          ls -la Builds/MacOSX/build/Release || echo "Build directory not found"
          
          # Copy plugins to the package directory
          cp -R Builds/MacOSX/build/Release/TremoloViola.vst3 package/VST3/ || echo "VST3 not found"
          cp -R Builds/MacOSX/build/Release/TremoloViola.component package/AU/ || echo "AU not found"
          
          # Zip the package
          cd package
          zip -r TremoloViola_Mac.zip .
          mv TremoloViola_Mac.zip ../
        
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TremoloViola_Mac
          path: TremoloViola_Mac.zip
          retention-days: 30
