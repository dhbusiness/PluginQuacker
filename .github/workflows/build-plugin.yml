name: Build QuackerVST Plugin
on:
  # Manual trigger from Actions tab
  workflow_dispatch:
jobs:
  build:
    name: Build macOS Plugin
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Update submodules (pull JUCE)
        run: |
          git submodule update --init --recursive
          
      - name: Setup Environment
        run: |
          echo "Setting up environment variables"
          echo "JUCE_VERSION=8.0.6" >> $GITHUB_ENV
          echo "PLUGIN_NAME=QuackerVST" >> $GITHUB_ENV
          
      - name: Print debug information
        run: |
          echo "Working directory:"
          pwd
          echo "Contents:"
          ls -la
          
      - name: Locate JUCE directory
        run: |
          echo "Looking for JUCE directory:"
          find . -type d -name "JUCE" | grep -v "build" || echo "JUCE directory not found"
          
      - name: Build Projucer
        run: |
          # Assuming JUCE is at the root level as a submodule
          cd JUCE/extras/Projucer/Builds/MacOSX
          xcodebuild -configuration Release
          
          echo "Projucer build complete. Contents of build directory:"
          ls -la build/Release
          
      - name: Make Projucer executable available
        run: |
          # Go back to root directory
          cd $GITHUB_WORKSPACE
          
          # Create symbolic link to Projucer
          ln -sf $GITHUB_WORKSPACE/JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app/Contents/MacOS/Projucer ./projucer
          
          # Verify link created successfully
          ls -la ./projucer
          
      - name: Resave JUCER file
        run: |
          echo "Current directory:"
          pwd
          
          echo "Finding .jucer files:"
          find . -name "*.jucer"
          
          echo "Resaving project file"
          ./projucer --resave QuackerVST/QuackerVST.jucer
          
      - name: Build Plugin
        run: |
          echo "Building plugin"
          cd QuackerVST/Builds/MacOSX
          xcodebuild -configuration Release
      
      - name: Package Plugin
        run: |
          echo "Packaging plugin"
          mkdir -p artifacts
          
          # Package VST3
          if [ -d "QuackerVST/Builds/MacOSX/build/Release/VST3/$PLUGIN_NAME.vst3" ]; then
            cd QuackerVST/Builds/MacOSX/build/Release/VST3
            zip -r ../../../../../artifacts/$PLUGIN_NAME-VST3-macOS.zip ./$PLUGIN_NAME.vst3
            cd ../../../../../
          fi
          
          # Package AU
          if [ -d "QuackerVST/Builds/MacOSX/build/Release/AU/$PLUGIN_NAME.component" ]; then
            cd QuackerVST/Builds/MacOSX/build/Release/AU
            zip -r ../../../../../artifacts/$PLUGIN_NAME-AU-macOS.zip ./$PLUGIN_NAME.component
            cd ../../../../../
          fi
          
          # Package Standalone
          if [ -d "QuackerVST/Builds/MacOSX/build/Release/Standalone/$PLUGIN_NAME.app" ]; then
            cd QuackerVST/Builds/MacOSX/build/Release/Standalone
            zip -r ../../../../../artifacts/$PLUGIN_NAME-Standalone-macOS.zip ./$PLUGIN_NAME.app
            cd ../../../../../
          fi
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macOS-Builds
          path: artifacts/
          retention-days: 30
